function boostrapMods(){$("[rel=tooltip]").tooltip(),$("[rel=popover]").popover(),$("[rel=popover]").click(function(e){e.preventDefault()}),$("[rel=popover][data-trigger=hover]").off("click"),$(".dropdown").on("show.bs.dropdown",function(){$(this).find(".dropdown-menu").first().stop(!0,!0).slideDown(100)}),$(".dropdown").on("hide.bs.dropdown",function(){$(this).find(".dropdown-menu").first().stop(!0,!0).slideUp(100)}),$(".dropdown-toggle").click(function(e){e.preventDefault()})}function bindEpicEditorFields(){defined("EpicEditor")&&$(".epiceditor-target").length>0&&$(".epiceditor-target").each(function(){bindEpicEditorField($(this))})}function bindEpicEditorField(e){console.log(e.find(".epiceditor"));var t={textarea:e[0],container:e.siblings(".epiceditor")[0],basePath:"/javascripts/epiceditor/",clientSideStorage:!1,localStorageName:"epiceditor",useNativeFullscreen:!0,parser:marked,file:{name:"epiceditor",defaultContent:"",autoSave:100},theme:{base:"themes/base/epiceditor.css",preview:"themes/preview/github.css",editor:"themes/editor/epic-dark.css"},focusOnLoad:!1,string:{togglePreview:"Toggle Preview Mode",toggleEdit:"Toggle Edit Mode",toggleFullscreen:"Enter Fullscreen"},autogrow:!0,minHeight:512};editor=new EpicEditor(t).load()}function appendErrors(e,t,i){for(var n in e){if(Array.isArray(e[n]))for(var o=0;o<e[n].length;o++)t.find(i).append(e[n][o]),t.find(i).append("<br>");else t.find(i).append(e[n]),t.find(i).append("<br>");animate(i,"fadeInUp")}}function bindUpload(){var e="#upload_frame",t=$(e);$(".js-upload-link").click(function(i){i.preventDefault(),stopEventPropagating(i),t.hasClass("animated")||$.ajax({url:"/upload/",success:function(i){i.success&&(t.html(i.html),showUploadFrame(e,t))},timeout:1e3,dataType:"json",error:function(){t.html("Could not load upload form."),showUploadFrame(e,t)}})}),$("html").click(function(i){eventTargetDoesNotInclude(i,"#upload_frame")&&(t.hasClass("animated")||"block"!=t.css("display")||animate(e,"fadeOutUp",function(){t.css("display","none")}))})}function showUploadFrame(e,t){t.css("display","block"),t.offset({left:$(".js-upload-link").offset().left,top:$(".js-upload-link").offset().top+40}),animate(e,"fadeInDown",null),$("form#Upload").off(),$("form#Upload").ajaxForm({beforeSubmit:function(){t.find(".errors").text(""),t.find(".file").text(""),$("form#Upload").find('input[type="submit"]').attr("disabled","disabled")},success:function(e){e.success?(t.find(".file").html("<a href='"+e.file+"'>View File</a>&nbsp;<a class='js-copy-link' href='"+e.file+"'>Get Link</a>"),t.find(".js-copy-link").click(function(e){e.preventDefault(),window.prompt("Copy to clipboard: Ctrl/Cmd+C, Enter",$(this).attr("href"))})):appendErrors(e.errors,t,".errors"),$("form#Upload").find('input[type="submit"]').attr("disabled",!1)},error:function(){t.find(".errors").append("Could not post comment, try again?"),$("form#Upload").find('input[type="submit"]').attr("disabled",!1)}})}function defined(e){return"undefined"!=typeof window[e]}function convertToSlug(e){return e.toLowerCase().replace(/[^\w ]+/g,"").replace(/ +/g,"-")}function convertToLowercase(e){return e.toLowerCase()}function supportsTransitions(){var e=document.body||document.documentElement,t=e.style,i="transition";if("string"==typeof t[i])return!0;var n=["Moz","webkit","Webkit","Khtml","O","ms"];i=i.charAt(0).toUpperCase()+i.substr(1);for(var o=0;o<n.length;o++)if("string"==typeof t[n[o]+i])return!0;return!1}function isVisible(e){return"none"!=e.css("display")&&"hidden"!=e.css("visibility")?!0:!1}function insertTextAtCursor(e){var t,i;window.getSelection?(t=window.getSelection(),t.getRangeAt&&t.rangeCount&&(i=t.getRangeAt(0),i.deleteContents(),i.insertNode(document.createTextNode(e)))):document.selection&&document.selection.createRange&&(document.selection.createRange().text=e)}function saveSelection(){if(window.getSelection){if(sel=window.getSelection(),sel.getRangeAt&&sel.rangeCount)return sel.getRangeAt(0)}else if(document.selection&&document.selection.createRange)return document.selection.createRange();return null}function restoreSelection(e){e&&(window.getSelection?(sel=window.getSelection(),sel.removeAllRanges(),sel.addRange(e)):document.selection&&e.select&&e.select())}function findBootstrapEnvironment(){var e=["ExtraSmall","Small","Medium","Large"],t=["xs","sm","md","lg"],i=$("<div>");i.appendTo($("body"));for(var n=t.length-1;n>=0;n--){var o=t[n];if(i.addClass("hidden-"+o),i.is(":hidden"))return i.remove(),e[n]}}function getViewportWidth(){return Math.max(document.documentElement.clientWidth,window.innerWidth||0)}function getViewportHeight(){return Math.max(document.documentElement.clientHeight,window.innerHeight||0)}function animate(e,t,i){animateElement($(e),t,i)}function animateElement(e,t,i){if(supportsTransitions()){e.attr("data-timeout-id")&&window.clearTimeout(e.attr("data-timeout-id")),e.addClass(t),e.addClass("animated");var n=window.setTimeout(function(){e.removeClass(t),e.removeClass("animated"),null!=i&&i(e)},2e3);e.attr("data-timeout-id",n),e.off(),e.one("webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend",function(){e.removeClass(t),e.removeClass("animated"),e.trigger("animationOver"),null!=i&&i(e)})}else i(e)}function stopEventPropagating(e){e||(e=window.event),e.stopPropagation?e.stopPropagation():e.cancelBubble=!0}function eventTargetDoesNotInclude(e,t){return 0==$(e.target).closest(t).length}function getTemplate(e){return $("#"+e+"_template").html()}function format(e,t){for(var i in t){var n=new RegExp("{{#"+i+"}}","g");e=e.replace(n,t[i])}return e}var aceUtil=new function(){this.convertTextAreas=function(e){var t;t="string"==typeof e?$(e):e,t.find("[data-editor]").each(function(){var e=$(this);if(e.prev().is(".ace_editor"))return void console.log("Already an ace editor");var t=e.data("editor"),i=$("<div>",{position:"absolute",width:e.width(),height:Math.max(64,e[0].scrollHeight),"class":e.attr("class")}).insertBefore(e);e.css("display","none");var n=ace.edit(i[0]);n.getSession().setValue(e.text()),n.getSession().setMode("ace/mode/"+t),n.getSession().setUseSoftTabs(!1),n.getSession().setUseWrapMode(!0),n.setTheme("ace/theme/terminal"),n.getSession().on("change",function(){e.text(n.getSession().getValue())})})}},mathjax=!1;$(function(){$("html").first().removeClass("no-js"),defined("Select2")&&$(".js-select2").select2(),jQuery().lazyload&&$("img.lazy").lazyload({threshold:200}),$(".step-body a[rel='definition']").each(function(){$(this).html($(this).html()+' <i class="fa fa-book"></i>'),"undefined"==typeof $(this).attr("title")&&$(this).attr("title","Show Definition"),$(this).tooltip()}),$(".step-body .comment a").tooltip(),$(".step-body a[href*='http']").each(function(){$(this).html($(this).html()+' <i class="fa fa-external-link"></i>'),"undefined"==typeof $(this).attr("title")&&$(this).attr("title",$(this).attr("href").trunc(50)),$(this).attr("target","new"),$(this).tooltip({placement:"top"})}),($("div:contains('{\\[')").length>0||$("div:contains('\\(')").length>0)&&(mathjax=!0,function(){var e,t=document.getElementsByTagName("head")[0];e=document.createElement("script"),e.type="text/x-mathjax-config",e[window.opera?"innerHTML":"text"]="MathJax.Hub.Config({\n});",t.appendChild(e),e=document.createElement("script"),e.type="text/javascript",e.src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML",t.appendChild(e)}())}),boostrapMods();var comments=new function(){var e=this;e.bindComments=function(){var t="#comment_frame",i=$(t);$(".step-body .comment, .shared-wrapper .comment").each(function(){{var n=$(this),o=$(this).parent().parent().parent().parent(),r=$(this).parent().parent().parent();$(this).prev()}if(r.is(".hideable-inner"))return $(this).remove(),!0;0==$(this).closest(".shared-wrapper").length&&$(this).html(parseInt($(this).attr("data-count"))>0?format(getTemplate("_comment_icon_with_count"),{"comment-count":$(this).attr("data-count")}):format(getTemplate("_comment_icon"),{"comment-count":$(this).attr("data-count")})),$(this).find("a").on("touchstart, click",function(r){if(r.preventDefault(),stopEventPropagating(r),!$("#comment_frame").hasClass("animated")){n.append(loadingIndicator);var a,s,d="";if("sharing_lightbox"==o.attr("id"))d="/comments/image-get/"+o.attr("data-id"),a=-160,s="auto";else{var c=window.location.href.substr(window.location.href.lastIndexOf("/")+1);c=c.split("#")[0],c=c.split("?")[0],d="/comments/get/"+c+"/"+$(this).parent().attr("data-group"),a=32,s=-64}$.ajax({url:d,success:function(o){o.success&&(i.html(o.html),e.showCommentFrame(t,i,n,a,s)),n.children().last().remove()},timeout:3e3,dataType:"json",error:function(){i.html("Could not load comments."),e.showCommentFrame(t,i,n,a,s),n.children().last().remove()}})}})}),$(".step-body :not(div) + p .comment").each(function(){$(this).prependTo($(this).parent())});var n=$(".step-body .comment").first();n.prependTo(n.parent()),$(".step-body div + p .comment").each(function(){$(this).parent().insertBefore($(this).parent().prev())}),$("html").on("touchstart, click",function(e){eventTargetDoesNotInclude(e,"#comment_frame")&&(i.hasClass("animated")||"block"!=i.css("display")||animate(t,"fadeOutUp",function(){i.css("display","none")}))})},e.showCommentFrame=function(e,t,i,n,o){var r="auto"==o;n||(n=32),o||(o=-64),t.css("display","block"),t.offset("ExtraSmall"==findBootstrapEnvironment()?{left:getViewportWidth()/2-t.outerWidth()/2,top:i.offset().top+o}:i.offset().left+n+t.outerWidth()>=getViewportWidth()?{left:getViewportWidth()-t.outerWidth()-10,top:i.offset().top+o}:{left:i.offset().left+n,top:i.offset().top+o}),animate(e,"fadeInDown",null),$("form#Comment").off(),$("form#Comment").ajaxForm({beforeSubmit:function(){t.find(".errors").text(""),$("form#Comment").find('input[type="submit"]').attr("disabled","disabled")},success:function(e){e.success?t.html(e.html):appendErrors(e.errors,t,".errors"),$("form#Comment").find('input[type="submit"]').attr("disabled",!1)},error:function(){t.find(".errors").append("Could not post comment, try again?"),$("form#Comment").find('input[type="submit"]').attr("disabled",!1)}}),r&&t.offset({top:i.offset().top-t.height()-32}),$(".js-close-comments").click(function(i){i.preventDefault(),animate(e,"fadeOutUp",function(){t.css("display","none")})}),$(".js-delete-comment").bind("click",function(e){if(e.preventDefault(),confirm("Delete this comment?")){var t=$(this).parent().parent();$.get($(this).attr("href")).done(function(e){e.success&&t.remove()}).fail(function(){})}}),$(".js-report-comment").bind("click",function(e){e.preventDefault(),confirm("Report this comment?")&&$.get($(this).attr("href")).done(function(e){alert(e.success?"Comment reported, thanks!":"Comment already reported.")}).fail(function(){})})}};comments.bindComments();var definitions=new function(){var e=this;e.convertDefinitionLinks=function(){$('a[href^="define:"]').each(function(){$(this).attr("rel","definition");var e=$(this).attr("href").replace("define:","");$(this).attr("data-query",e)})},e.bindDefinitions=function(){$("a[rel='definition']").click(function(e){var t=$(this);e.preventDefault();var i=$(this).attr("data-query");t.after(loadingIndicator),$.ajax({url:"/definitions/define/"+i,success:function(e){if("null"!=e&&null!=e){$(".step-body .js-inserted-definition").remove();var i=format(getTemplate("_inserted_definition"),{"definition-title":e.title,"definition-body":marked(e.body),"definition-id":e._id});t.parent().after(i),animate(t.parent().next(),"fadeInUp"),mathjax&&MathJax.Hub.Queue(["Typeset",MathJax.Hub,t.parent().next()[0]]),$(".js-close-inserted-definition").click(function(e){e.preventDefault(),animate($(this).parent(),"fadeOutDown",function(e){e.remove()})})}t.next().remove()},timeout:3e3,dataType:"json",error:function(){t.next().remove(),console.log("Could not load definition.")}})}),$(".js-insert-definition").click(function(e){e.preventDefault();var t='{definition{"TITLE", "TERM"}}';prompt("Macro:",t),editor.focus()}),$(".js-insert-inline-definition").click(function(e){e.preventDefault();var t='{inline-definition{"TERM"}}';prompt("Macro:",t),editor.focus()}),$(".js-insert-inline-tex").click(function(e){e.preventDefault();var t="\\\\( \\\\)";prompt("Tex:",t),editor.focus()}),$(".js-insert-block-tex").click(function(e){e.preventDefault();var t="\\\\[ \\\\]";prompt("Tex:",t),editor.focus()}),$(".js-insert-two-cols").click(function(e){e.preventDefault();var t='{two-columns{"one", "two"}}';prompt("Macro:",t),editor.focus()}),$(".js-insert-one-col").click(function(e){e.preventDefault();var t='{one-column{"content"}}';prompt("Macro:",t),editor.focus()})}};definitions.convertDefinitionLinks(),definitions.bindDefinitions();var editor;bindEpicEditorFields();var hideable=new function(){var e=this;e.createHideableRegions=function(){$(".hideable-inner").each(function(){var e=$(this).closest(".content-block"),t=e.next();t.css("visibility","hidden")}),$(".js-toggle-hideable").click(function(e){e.preventDefault();var t=$(this).closest(".content-block"),i=t.next();isVisible(i)?($(this).text("Expand"),animateElement(i,"fadeOutLeftBig",function(e){e.css("visibility","hidden")})):($(this).text("Hide"),i.css("visibility","visible"),animateElement(i,"fadeInLeftBig"))})},e.bindInsertRegionButton=function(){$(".js-insert-hideable").click(function(e){e.preventDefault();var t="{hideable{TITLE, CONTENT}}";prompt("Macro:",t),editor.focus()})}};hideable.createHideableRegions(),hideable.bindInsertRegionButton();var learn=new function(){var e=this;e.setup=function(){$(".banner-image").each(function(){var e=$(this),t=e.attr("data-background");t&&""!=t&&"#"!=t[0]?e.css("background-image","url("+t+")"):t&&""!=t&&e.css("background-color",t)}),$("[data-bg]").each(function(){$(this).css("background-color",$(this).attr("data-bg"))}),$("[data-colour]").each(function(){$(this).css("color",$(this).attr("data-colour"))}),jQuery().lazyload?$(".step-body img").lazyload({threshold:200,load:e.lazyLoadHandler}):$(".step-body img").each(function(){$(this).attr("src",$(this).attr("data-original"))})},e.lazyLoadHandler=function(){$(this).attr("data-caption",$(this).attr("alt")),$(this).addClass("plus-cursor"),Intense(this)}};learn.setup();var loadingIndicator='<div class="spinner"><div class="bounce1"></div><div class="bounce2"></div><div class="bounce3"></div></div>',notifications=new function(){var e=this;e.bindRemoveLinks=function(){$(".remove-notification").click(function(e){e.preventDefault(),e.stopPropagation();var t=$(this).closest(".dropdown-menu");console.log(t);var i=$(this).closest("li");$.postWithCsrf("/notifications/remove/"+i.attr("data-id"),{},function(e){e.success||console.error("Notification "+i.attr("data-id")+" could not be removed.")}),i.remove(),$(".notification-badge").text(parseInt($(".notification-badge").text())-1),0==t.children().length&&(t.remove(),$(".notifications").remove())})}};notifications.bindRemoveLinks();var paymentValidation=new function(){this.init=function(){function e(e,t){var i=$("#editAccountSettingsForm");if(t.error)i.find(".payment-errors").text(t.error.message),i.find("button").prop("disabled",!1);else{var n=t.id;i.append($('<input type="hidden" name="stripeToken" />').val(n)),i.get(0).submit()}}return"undefined"==typeof Stripe||"undefined"==typeof jQuery.payment?void console.error("Payment Validation has a hard dependency on the Stripe API and the jQuery Payment Plugin."):(Stripe.setPublishableKey("#{stripe_publishable_key}"),$("#cc_num").payment("formatCardNumber"),$("#cc_cvc").payment("formatCardCVC"),$("#cc_expire").payment("formatCardExpiry"),$("#cc_expire").keyup(function(){var e=$(this).payment("cardExpiryVal");$("#cc_exp_month").val(e.month),$("#cc_exp_year").val(e.year)}),void $("#editAccountSettingsForm").submit(function(){var t=$(this);return t.find("button").prop("disabled",!0),Stripe.card.createToken(t,e),!1}))}},progress=new function(){var e=this;e.updateProgressBars=function(){if($(".progress-list-wrapper .progress").each(function(){var e=($(this),$(this).parent()),t=e.find("ul.progress-list li:first a"),i=e.find("ul.progress-list li.current-step a");$(this).css("width",i.offset().left-t.offset().left),$(this).css("left",t.position().left+2),$(this).css("top",t.position().top)}),$(".course-progress-node").length>0){var t=e.getVerticalProgressPoints(),i=t.first,n=t.upto,o=t.last;nodeWidth=i.outerWidth()-3;var r=$(".vertical-progress-done");r.css("height",n.offset().top-i.offset().top),r.css("left",i.offset().left+nodeWidth/2),r.css("top",i.offset().top+nodeWidth/2);var a=$(".vertical-progress-todo");a.css("height",o.offset().top-n.offset().top),a.css("left",n.offset().left+nodeWidth/2),a.css("top",n.offset().top+nodeWidth/2)}},e.getVerticalProgressPoints=function(){var e=$(".course-progress-node.first"),t=$(".course-progress-node.done:last"),i=$(".course-progress-node:last");return 0==t.length&&(t=e),{first:e,upto:t,last:i}},e.initVerticalBars=function(){if($(".course-progress-node").length>0){$("body").prepend("<div class='vertical-progress-done'></div>"),$("body").prepend("<div class='vertical-progress-todo'></div>");var e=$(".course-progress-node").not(".done").first().parent().next(),t=e.find("a").attr("href");e.find(".box").prepend("<a href='"+t+"' class='button create-button float-right lets-go'>Let's Go!</div>")}},e.initHorizontalBars=function(){$(".progress-list-wrapper").prepend("<div class='progress'></div>")},e.bindProgressBarResize=function(){e.updateProgressBars(),window.setTimeout(e.updateProgressBars,1e3),$(".course-progress-node").length>0&&window.setInterval(e.updateProgressBars,100),$(window).resize(e.updateProgressBars),supportsTransitions()&&e.runBarUpdate()},e.barUpdateCount=0,e.runBarUpdate=function(){e.barUpdateCount++,e.barUpdateCount<100&&(requestAnimationFrame(e.runBarUpdate),e.updateProgressBars())}};progress.initHorizontalBars(),progress.bindProgressBarResize(),progress.initVerticalBars();var search=new function(){var e=this;e.searchTerm="",e.categoryFilter="",e.bindDefinitionSearchField=function(){$(".js-definition-filter").keyup(function(){var e=$(this).val().toLowerCase();$(".definition-block").each(function(){var t=$(this).attr("data-definition-name").toLowerCase(),i=!1;(t.indexOf(e)>=0||e.indexOf(t)>=0)&&(i=!0),i?$(this).parent().show():$(this).parent().hide()})})},e.bindCourseSearchField=function(){$(".js-course-filter").keyup(function(){e.searchTerm=$(this).val().toLowerCase(),e.filterCourses(e.searchTerm,e.categoryFilter)}),$(".js-category-tag").click(function(){"true"!=$(this).attr("data-selected")?(e.categoryFilter=$(this).attr("data-category").toLowerCase(),$(".js-category-tag").each(function(){$(this).css("background-color",$(this).attr("data-bg")),$(this).attr("data-selected","false")}),$(this).css("background-color",$(this).attr("data-bg-selected")),$(this).attr("data-selected","true")):(e.categoryFilter="",$(this).css("background-color",$(this).attr("data-bg")),$(this).attr("data-selected","false")),e.filterCourses(e.searchTerm,e.categoryFilter)})},e.filterCourses=function(e,t){$(".course-block").each(function(){var i=$(this).attr("data-category-name").toLowerCase(),n=$(this).attr("data-course-name").toLowerCase(),o=!1;(n.indexOf(e)>=0||e.indexOf(n)>=0||i.indexOf(e)>=0||e.indexOf(i)>=0)&&(o=!0),-1==i.indexOf(t)&&(o=!1),o?$(this).parent().show():$(this).parent().hide()})}};search.bindCourseSearchField(),search.bindDefinitionSearchField();var sharing=new function(){var e=$("form#addSharedImageForm"),t=this;t.bindSharingImageForm=function(){e.ajaxForm({beforeSubmit:function(){e.find(".errors").text(""),e.find('input[type="submit"]').attr("disabled","disabled")},success:function(t){t.success?t.refresh&&location.reload(!0):appendErrors(t.errors,e,".errors"),e.find('input[type="submit"]').attr("disabled",!1)},error:function(){e.find(".errors").append("Could not share image, try again?"),e.find('input[type="submit"]').attr("disabled",!1)}})},t.bindLikeImage=function(){$(".likes .like-image").click(function(e){var t=$(this);e.preventDefault(),$.get($(this).attr("href"),function(e){e&&e.success&&t.parent().find(".likes-count").text(e.like_count)})})},t.bindImageClick=function(){$("img.shared-image").lazyload({threshold:200,load:learn.lazyLoadHandler})},t.bindPageResize=function(){t.updateLearnGrid(),$(window).resize(t.updateLearnGrid)},t.updateLearnGrid=function(){$(".shared-image-holder").each(function(){$(this).css("height",$(this).css("width"))})},$("#shared_image_shared_image").change(function(){this.files[0].size/1048576>2?e.find(".errors").append("This file is too large (bigger than 2MB), try compressing or resizing it."):e.ajaxSubmit({url:"/upload-image/",type:"post",beforeSubmit:function(){e.find(".errors").text(""),e.find('input[type="submit"]').attr("disabled","disabled")},success:function(t){t.success?($("#shared_image_url").val(t.file),$("#shared_image_preview").attr("src",t.file)):appendErrors(t.errors,e,".errors"),e.find('input[type="submit"]').attr("disabled",!1)},error:function(){e.find(".errors").append("Could not share image, try again?"),e.find('input[type="submit"]').attr("disabled",!1)}})})};sharing.bindImageClick(),sharing.bindSharingImageForm(),sharing.bindPageResize(),sharing.bindLikeImage();var slug=new function(){var e=this;e.bindSlugFields=function(){$(".js-slug").keyup(function(){var e="#"+$(this).attr("data-object")+"_"+$(this).attr("data-target");$(e).val(convertToSlug($(this).val()))})},e.bindLowercaseFields=function(){$(".js-lowercase").keyup(function(){var e="#"+$(this).attr("data-object")+"_"+$(this).attr("data-target");$(e).val(convertToLowercase($(this).val()))})}};slug.bindSlugFields(),slug.bindLowercaseFields();var sortable=new function(){var e=this;this.bindDeleteLinks=function(){$(".js-sortable-delete-link").off(),$(".js-sortable-delete-link").bind("click",function(e){e.preventDefault(),$(this).parent().remove()})},this.sortable=function(e,t){t.onDrop=function(e,i,n,o){e.removeClass("dragged").removeAttr("style"),$("body").removeClass("dragging"),t.afterDrag&&t.afterDrag(o)},e.sortable(t)},this.bindSortableLists=function(t,i){i="undefined"!=typeof i?i:".js-sortable",console.log("HELO"),null==t&&(t={},t.afterDrag=function(){}),jQuery().sortable&&($(i).off(),$(".js-sortable-add-new").off(),t.onDrop=function(e){e.removeClass("dragged").removeAttr("style"),$("body").removeClass("dragging"),t.afterDrag&&t.afterDrag()},$(i).sortable(t),e.bindDeleteLinks(),$(".js-sortable-add-new").click(function(t){var i=$($(this).attr("data-read-selection-from")),n=$(this).attr("data-hidden-field-name"),o=$($(this).attr("data-target-list"));t.preventDefault(),o.append(format(getTemplate("_sortable_content_list_entry"),{"item-text":i.find("option:selected").text(),"field-name":n,"field-value":i.val()})),e.bindDeleteLinks()}))}},twoCols=new function(){this.repositionColumns=function(){$(".two-cols").each(function(){var e=$(this).next(),t=$(this).next().next();e.detach().appendTo($(this).find(".col1")),t.detach().appendTo($(this).find(".col2"))})}};twoCols.repositionColumns(),bindUpload(),$.postWithCsrf=function(e,t,i){t[$("meta[name=csrf-param]").attr("content")]=$("meta[name=csrf-token]").attr("content"),$.post(e,t,i)},String.prototype.trunc=String.prototype.trunc||function(e){return this.length>e?this.substr(0,e-3)+"...":this};var AjaxFormView=Backbone.View.extend({initialize:function(e){this.ajaxForm(),this.success=e.success?e.success:this.defaultSuccess,this.failure=e.failure?e.failure:this.defaultFailure,this.beforeSubmit=e.beforeSubmit?e.beforeSubmit:this.defaultBeforeSubmit,this.refreshPage=!1,e.refreshPage&&(this.refreshPage=e.refreshPage)},defaultBeforeSubmit:function(){},defaultSuccess:function(e){e.success?(console.log("Form submission returned success"),this.refreshPage&&(console.log("Refreshing page."),window.location.reload())):console.error("Form submission returned failure")},defaultFailure:function(){console.error("Form submission failed")},ajaxForm:function(){var e=this;this.$el.ajaxForm({beforeSubmit:function(t,i,n){e.beforeSubmit(t,i,n)},success:function(t,i,n,o){e.success(t,i,n,o)},error:function(t,i,n,o){e.failure(t,i,n,o)}})}});_.templateSettings={interpolate:/\%\%=(.+?)\%\%/g,escape:/\%\%-(.+?)\%\%/g,evaluate:/\%\%(.+?)\%\%/g};var iconTab=new function(){this.initialised=!1,this.init=function(){this.initialised||($(".icon-button-tab").click(function(e){e.preventDefault();var t=parseInt($(this).attr("data-target"));console.debug(t);var i=$(".landing-page-box");i.removeClass("visible"),$(i[t]).addClass("visible")}),this.initialised=!0)}},ComposeStepView=Backbone.View.extend({initialize:function(){console.log("INIT"),this.rebuildIdList(),this.countSubmits=0,sortable.sortable(this.$el.find(".js-sortable-blocks"),{afterDrag:this.rebuildIdList,itemSelector:".content",handle:"h4"}),this.ajaxForm()},events:{"click .js-add-content":"addContent"},beginSubmits:function(){this.countSubmits=0,this.$el.find(".content form").submit()},ajaxForm:function(){this.$el.ajaxForm({beforeSubmit:function(){},success:function(e){e.success?(console.log("Form submission returned success, refreshing page..."),window.location.reload()):console.error("Form submission returned failure")},error:function(){console.error("Form submission failed")}})},addContent:function(e){var t=$(e.target),i=t.attr("data-content"),n=new ComposeStepContentView({template:_.template($("#"+i+"_template").html()),parent:this});this.$el.find(".contents").append(n.render().el),n.convertTextArea(),n.ajaxForm()},rebuildIdList:function(){console.log("Rebulding id list"),$(".content-ids").html(""),$(".contents .content .id-field").each(function(){var e=_.template($("#_step_content_id_entry_template").html()),t=e({id:$(this).val()});$(".content-ids").append(t)})},contentSubmissionDone:function(){this.countSubmits+=1,this.countSubmits==this.$el.find(".content form").length&&this.finishedSubmissions()},contentSubmissionError:function(){console.error("Submission of one content block failed."),this.countSubmits=0},finishedSubmissions:function(){this.$el.find("#addStepForm").submit()}}),ComposeStepContentView=Backbone.View.extend({initialize:function(e){this.template=e.template,this.parent=e.parent,this.convertTextArea(),this.ajaxForm()},events:{"click .js-delete-content":"deleteSelf","click .js-minimise-content":"minimiseSelf","change .code-input-language":"codeLanguageChange"},convertTextArea:function(){aceUtil.convertTextAreas(this.$el)},ajaxForm:function(){var e=this;this.$el.find("form").ajaxForm({beforeSubmit:function(){},success:function(t,i,n,o){t.success?(o.find(".id-field").val(t.id),e.parent.rebuildIdList(),e.parent.contentSubmissionDone()):e.parent.contentSubmissionError()},error:function(){console.error(":("),e.parent.contentSubmissionError()}})},render:function(){var e=this.template({});return this.setElement(e),this},deleteSelf:function(e){e.preventDefault();var t=confirm("Are you sure you want to remove this content block?");t&&this.remove()},minimiseSelf:function(e){e.preventDefault(),this.$el.toggleClass("minimised")},codeLanguageChange:function(e){var t=$(e.target),i=ace.edit(t.siblings(".ace_editor")[0]);console.log(i),i.getSession().setMode("ace/mode/"+t.val())}}),SortableItem=Backbone.Model.extend({defaults:{title:"",field_name:"",id:"",link:"#",cssClass:""},initialize:function(e){!e.id&&e._id.$oid&&this.set({id:e._id.$oid})}}),SortableItemCollection=Backbone.Collection.extend({model:SortableItem}),SortableItemView=Backbone.View.extend({initialize:function(e){this.params=e.params},events:{"click .js-sortable-delete-link":"deleteSelf"},template:_.template($("#_sortable_content_list_entry_backbone_template").html()),render:function(){var e=this.template(this.model.toJSON());return this.setElement(e),this},deleteSelf:function(e){e.preventDefault(),this.remove()}}),SortableItemListView=Backbone.View.extend({initialize:function(e){this.$el.find(".js-sortable").sortable({}),this.$readSelectionFrom=$(this.el).find(".js-select2"),this.hiddenFieldName=e.hiddenFieldName,this.$targetList=this.$el.find(e.targetList),this.views=[],console.log(this),this.render()},events:{"click .js-sortable-add-new":"addEntry"},render:function(){return _.each(this.views,function(e){e.remove()}),this.views=[],this.collection.each(function(e){e.set({field_name:this.hiddenFieldName});var t=new SortableItemView({model:e});this.views.push(t),this.$targetList.append(t.render().el)},this),this},addEntry:function(e){e.preventDefault(),console.log("Add Entry");var t=new SortableItem({title:this.$readSelectionFrom.find("option:selected").text(),field_name:this.hiddenFieldName,id:this.$readSelectionFrom.val()});console.log(t),this.collection.add(t),this.render()}});